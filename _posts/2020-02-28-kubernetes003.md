---
title: "Kubernetes - 03.Service ìƒ"
date: 2020-02-28 00:00:00 +0800
categories: kubernetes
sidebar:
  title: "Development"
  nav: "dev-sidebar"
---

## 1. êµ¬ì„±í™˜ê²½

- GCP VMì— minikubeë¡œ kubernetes ì‹¤í–‰í™˜ê²½ êµ¬ì„±
- Podì— í™œìš©í•  ì´ë¯¸ì§€ì—ì„œ ì—°ë™í•˜ëŠ” RedisëŠ” AWSì— êµ¬ì„±

## 2. Redis êµ¬ë™

```sh 
cd /engn001/redis #ê²½ë¡œ ì´ë™
nohup ./src/redis-server ./redis.conf & #background ì‹¤í–‰
ps aux | grep redis #ê¸°ë™ í™•ì¸
```

## 3. minikube êµ¬ë™

```sh 
minikube start
kubectl get nodes
```

## 4. Deployment ìƒì„±

- kubectl run ëª…ë ¹ì–´ê°€ ì•„ë‹Œ yaml íŒŒì¼ì— ì„¤ì • ì •ë³´ë¥¼ ëª…ì‹œí•˜ì—¬ ìƒì„±

- íŒŒì¼ëª…: my-deploy.yaml

```yaml 

apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-deploy-name #ë””í”Œë¡œì´ë¨¼íŠ¸ ì´ë¦„
  labels:
    app: my-deploy
spec:
  replicas: 3 #3ê°œì˜ ë ˆí”Œë¦¬ì¹´ íŒŒë“œ ìƒì„±
  selector: #ë””í”Œë¡œì´ë¨¼íŠ¸ê°€ ê´€ë¦¬í•  íŒŒë“œë¥¼ ì°¾ëŠ” ë°©ë²• 
    matchLabels:
      app: my-deploy
  template:
    metadata:
      labels:
        app: my-deploy
    spec:
      containers:
        - name: mycontainer
          image: sftth/whms:1.1
          ports:
          - containerPort: 8080
```

[ì„¤ì •ì°¸ê³ ](https://kubernetes.io/ko/docs/concepts/workloads/controllers/deployment/)

```sh 
kubectl create -f my-deploy.yaml
(ìƒì„±ë˜ì–´ ìˆìœ¼ë©´ kubectl delete deployment my-deploy-name)
```

## 5. ì„œë¹„ìŠ¤ ìƒì„±

- ë””í”Œë¡œì´ë¨¼íŠ¸ë¥¼ í†µí•´ ìƒì„±ëœ í¬ë“œì˜ ì™¸ë¶€ ë…¸ì¶œì„ ìœ„í•´ ì„œë¹„ìŠ¤ ìƒì„±ì´ í•„ìš”
- ìƒì„± íŒŒì¼: my-service.yaml

```yaml 
apiVersion: v1
kind: Service
metadata:
  name: my-service-name #ì„œë¹„ìŠ¤ ì´ë¦„ ì§€ì •
spec:
  ports:
    - name: my-deploy-svc
      port: 8080 #ì™¸ë¶€ ë…¸ì¶œ í¬íŠ¸
      targetPort: 8080 #ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í¬íŠ¸
  type: LoadBalancer #Externel IP í™œìš© ìœ í˜•
  selector:
    app: my-deploy #ì™¸ë¶€ ë…¸ì¶œ podsì˜ label ì„ íƒ
```

```sh 
kubectl create -f my-service.yaml
(ìƒì„±ë˜ì–´ ìˆìœ¼ë©´ kubectl delete svc my-service-name)
```

## 6. í™•ì¸

- ë…¸ë“œ í™•ì¸

```sh 
[***@gcp-minikube-vm minikube]$ kubectl get nodes
NAME       STATUS   ROLES    AGE     VERSION
minikube   Ready    master   6d14h   v1.17.3
```

- ë””í”Œë¡œì´ í™•ì¸

```sh 
[***@gcp-minikube-vm minikube]$ kubectl get deployment
NAME             READY   UP-TO-DATE   AVAILABLE   AGE
my-deploy-name   3/3     3            3           14h
```

- Pods í™•ì¸

```sh 
[***@gcp-minikube-vm minikube]$ kubectl get pods
NAME                              READY   STATUS    RESTARTS   AGE
my-deploy-name-75876fb9db-pfpz5   1/1     Running   0          14h
my-deploy-name-75876fb9db-sm2pd   1/1     Running   0          14h
my-deploy-name-75876fb9db-vxxdt   1/1     Running   0          14h
```

- ì„œë¹„ìŠ¤ í™•ì¸

```sh 
[Summit@gcp-minikube-vm minikube]$ kubectl get service
NAME              TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
kubernetes        ClusterIP      10.96.0.1        <none>        443/TCP          6d14h
my-service-name   LoadBalancer   10.106.205.160   <pending>     8080:32025/TCP   3h36m
```

## 7. ì™¸ë¶€ ì ‘ì† 

- minikubeì˜ ê²½ìš° service íƒ€ì…ì„ LoadBalancer ì„¤ì •ì„ í•´ë„ External-IPê°€ pendingìœ¼ë¡œ ìƒì„±ë˜ì§€ ì•ŠìŒ

```sh 
[***@gcp-minikube-vm minikube]$ kubectl get svc
NAME              TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
kubernetes        ClusterIP      10.96.0.1        <none>        443/TCP          6d10h
my-service-name   LoadBalancer   10.106.205.160   <pending>     8080:32025/TCP   51s
```

- minikubeëŠ” LoadBalancer íƒ€ì…ì„ ì§€ì›í•˜ì§€ ì•Šê³  NodePortë§Œ ì§€ì›ì´ ë˜ë¯€ë¡œ ì´ ê²½ìš°ëŠ” ì•„ë˜ì™€ ê°™ì´ ë¡œì»¬ ë‚´ë¶€ì—ì„œ
ì ‘ì† í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒìœ¼ë¡œ ê²€ì¦ ê°€ëŠ¥

```sh 
[***@gcp-minikube-vm minikube]$ minikube service my-service-name
|-----------|-----------------|---------------|-----------------------------|
| NAMESPACE |      NAME       |  TARGET PORT  |             URL             |
|-----------|-----------------|---------------|-----------------------------|
| default   | my-service-name | my-deploy-svc | http://192.168.99.100:32025 |
|-----------|-----------------|---------------|-----------------------------|
ğŸ‰  Opening service default/my-service-name in default browser...
xdg-open: no method available for opening 'http://192.168.99.100:32025'

ğŸ’£  open url failed: http://192.168.99.100:32025: exit status 3

ğŸ˜¿  minikube is exiting due to an error. If the above message is not useful, open an issue:
ğŸ‘‰  https://github.com/kubernetes/minikube/issues/new/choose

[***@gcp-minikube-vm minikube]$ curl http://192.168.99.100:32025/signIn
```

## 8. ë¡œê·¸í™•ì¸

```sh 
kubectl describe pods #pod ì •ë³´ í™•ì¸
kubectl logs podName #pod ë¡œê·¸ í™•ì¸
```